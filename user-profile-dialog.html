<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-input.html">

<link rel="import" href="../etools-dialog/etools-dialog.html">
<link rel="import" href="../etools-dropdown/etools-dropdown.html">"
<link rel="import" href="../etools-dropdown/etools-dropdown-multi.html">"

<link rel="import" href="scripts/lodash.html">

<dom-module id="etools-user-profile-dialog">
  <template>
    <style>
      [hidden] {
        display: none !important;
      }

      :host {
        --paper-dialog-scrollable: {
          width: 100%;
          overflow-x: hidden;
          max-height: 600px;
        };
      }

      paper-input {
        width: 100%;
      }

      #profile-content {
        overflow: hidden;
        box-sizing: border-box;
        @apply --user-profile-dropdown-content;
      }

      .row-h {
        @apply --layout-horizontal;
      }

      .flex-c {
        /* flex container */
        @apply --layout-flex;
      }

      .row-h + .row-h, .row-v + .row-v {
        margin-top: 20px;
      }

      .row-h:first-child + .row-v {
        margin-top: 0;
      }

      .col {
        @apply --layout-horizontal;
        box-sizing: border-box;
      }

      .col:not(:first-child) {
        padding-left: 24px;
      }

      .col-6 {
        flex: 0 0 50%;
        max-width: 50%;
      }

      .col-12 {
        flex: 0 0 100%;
        max-width: 100%;
      }

    </style>

    <etools-dialog id="userProfileDialog" size="lg" ok-btn-text="Save" dialog-title="My Profile"
                   on-close="_closeUserProfileDialog">

      <div id="profile-content">
        <div class="row-h flex-c">
          <div class="col col-6">
            <etools-dropdown id="office"
                             label="Office"
                             placeholder="&#8212;"
                             selected="{{profile.office}}"
                             options="[[offices]]"
                             auto-validate
                             error-message="Please select an office">
            </etools-dropdown>
          </div>
          <div class="col col-6">
            <etools-dropdown id="section"
                             label="Section"
                             placeholder="&#8212;"
                             selected="{{profile.section}}"
                             options="[[sections]]"
                             auto-validate
                             error-message="Please select a section">
            </etools-dropdown>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <paper-input label="Job title" value="{{profile.job_title}}" placeholder="&#8212;"></paper-input>
          </div>
          <div class="col col-6">
            <paper-input label="Phone number" value="{{profile.phone_number}}" placeholder="&#8212;"></paper-input>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-6">
            <paper-input id="supervisor"
                         label="My supervisor"
                         placeholder="&#8212;"
                         value="[[profile.supervisor]]"
                         readonly>
            </paper-input>
          </div>
          <div class="col col-6">
            <etools-dropdown id="oic"
                             label="My OIC"
                             placeholder="&#8212;"
                             selected="{{profile.oic}}"
                             options="[[users]]"
                             auto-validate
                             error-message="Please select an OIC">
            </etools-dropdown>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-12">
            <etools-dropdown-multi id="workspaces"
                                   label="Available workspaces"
                                   placeholder="&#8212;"
                                   selected-values="[[availableCountryIds]]"
                                   options="[[profile.countries_available]]"
                                   option-value="id"
                                   option-label="name"
                                   readonly>
            </etools-dropdown-multi>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-12">
            <etools-dropdown-multi id="groups"
                                   label="My Groups"
                                   placeholder="&#8212;"
                                   selected-values="[[availableGroups]]"
                                   options="[[profile.groups]]"
                                   option-value="id"
                                   option-label="name"
                                   readonly>
            </etools-dropdown-multi>
          </div>
        </div>
        <div class="row-h flex-c">
          <div class="col col-12">
            <etools-dropdown-multi id="supervisees"
                                   label="My supervisees"
                                   placeholder="&#8212;"
                                   selected-values="[[profile.supervisees]]"
                                   options="[[users]]"
                                   readonly>
            </etools-dropdown-multi>
          </div>
        </div>
      </div>

    </etools-dialog>

  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     */
    class EtoolsUserProfileDialog extends Polymer.Element {

      static get is() {
        return 'etools-user-profile-dialog';
      }

      static get properties() {
        return {
          profile: {
            type: Object,
            notify: true
          },
          availableCountryIds: Array,
          availableGroups: Array
        };
      }

      static get observers() {
        return ['_mapIds(profile)'];
      }

      openUserProfileDialog() {
        this.$.userProfileDialog.opened = true;
      }

      _centerDialog() {
        let d = this.$.userProfileDialog.shadowRoot.querySelector('paper-dialog');
        if (d) {
          d.center();
        }
      }

      _closeUserProfileDialog(e) {
        if (e.detail.confirmed) {
          this.saveData();
        }
      }

      _mapIds(profile) {
        if (profile === undefined) {
          return;
        }
        let availableCountryIds = _.map(this.profile.countries_available, 'id');
        let availableGroups = _.map(this.profile.groups, 'id');

        this.set('availableCountryIds', availableCountryIds);
        this.set('availableGroups', availableGroups);
      }

      resetData() {
        this.set('profile', JSON.parse(JSON.stringify(this.userProfileModel)));
      }

      saveData() {
        this.dispatchEvent(new CustomEvent('trigger-profile-save', {
          detail: {profile: this.profile},
          bubbles: true,
          composed: true
        }));
      }

      _convertOffices(data) {
        let offices = data.map((office) => {
          return {label: office.name, value: office.id}
        });
        this.set('allOffices', offices);
      }

    }

    window.customElements.define(EtoolsUserProfileDialog.is, EtoolsUserProfileDialog);
  </script>
</dom-module>
